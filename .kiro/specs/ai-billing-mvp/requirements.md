# AI 计费系统 MVP - 需求文档

**版本**: 1.0  
**日期**: 2026-02-03  
**状态**: 规划中  
**优先级**: P1 - 重要  
**时间线**: 6 周

---

## 1. 执行摘要

基于完整的 AI 计费系统设计，本 MVP 版本聚焦于核心功能，快速验证市场需求。延后复杂的 ML 异常检测和动态费率系统，优先实现基础的 Session Keys 和 HTTP 402 微支付网关。

**MVP 范围**：
- ✅ Session Key 智能合约和管理系统
- ✅ 基础 HTTP 402 中间件（Node.js）
- ✅ 状态通道累积器（Go）
- ✅ 简单规则引擎（Go）
- ✅ Session Key 管理界面
- ❌ ML 异常检测（延后到 v2）
- ❌ 动态费率系统（延后到 v2）
- ❌ Python/Go SDK（延后到 v2）

**目标**：
- 2-3 个早期客户试用
- 处理 10,000+ 微支付交易
- 验证产品市场契合度

---

## 2. 核心功能需求

### 2.1 Session Key 系统

**用户故事**：
> 作为 AI 服务用户，我需要一次性授权 AI 服务自动扣款，而不是每次调用都签名。

**验收标准**：
- [ ] 用户可以创建 Session Key（设置限额、有效期、合约白名单）
- [ ] Session Key 在链上注册和验证
- [ ] 支持冻结和解冻 Session Key
- [ ] 实时查看 Session Key 使用情况
- [ ] Session Key 到期自动失效

**技术要求**：
- Solidity 智能合约（SessionKeyValidator）
- TypeScript 服务层（session-key-service.ts）
- React 前端界面
- 链上事件监听

**简化点**：
- 不支持密钥轮换（v2 功能）
- 不支持批量创建（v2 功能）
- 只支持单一合约白名单（不支持多合约）

---

### 2.2 HTTP 402 微支付网关

**用户故事**：
> 作为 API 服务商，我需要在 API 端点前添加支付验证，只有支付的请求才能访问。

**验收标准**：
- [ ] 拦截 API 请求，验证 Session Key
- [ ] 检查余额是否充足
- [ ] 记录使用量（链下累积）
- [ ] 返回 402 Payment Required（余额不足时）
- [ ] 提供 Express 中间件

**技术要求**：
- Node.js/TypeScript 实现
- Redis 缓存验证结果
- Express 中间件封装

**简化点**：
- 只支持 Node.js/Express（不支持 NestJS）
- 不支持手动验证 API（只有中间件）
- 固定费率（不支持动态定价）

---

### 2.3 状态通道累积器

**用户故事**：
> 作为系统，我需要在链下累积小额支付，达到阈值后批量上链结算，减少 Gas 费用。

**验收标准**：
- [ ] Redis 原子累积使用量
- [ ] 达到阈值（10 USDC）触发链上结算
- [ ] 结算成功后重置计数器
- [ ] 结算失败时重试机制
- [ ] 发送 Webhook 通知

**技术要求**：
- Go 实现（高性能）
- Redis INCRBY 原子操作
- 智能合约调用
- 重试队列

**简化点**：
- 固定阈值（10 USDC，不可配置）
- 简单重试机制（最多 3 次）
- 不支持手动触发结算

---

### 2.4 基础规则引擎

**用户故事**：
> 作为用户，我需要系统监控异常消费行为，在发现问题时自动冻结 Session Key。

**验收标准**：
- [ ] 规则 1: 单次金额异常（> 平均值 10 倍）
- [ ] 规则 2: 调用频率异常（> 100 次/分钟）
- [ ] 规则 3: 余额低于 10% 告警
- [ ] 触发规则时自动冻结 Session Key
- [ ] 发送告警通知（Email/Webhook）

**技术要求**：
- Go 规则引擎
- 简单阈值检测（不使用 ML）
- 告警通知系统

**简化点**：
- 固定规则（不支持自定义）
- 简单阈值检测（不使用 Z-Score）
- 不支持白名单（v2 功能）

---

### 2.5 Session Key 管理界面

**用户故事**：
> 作为用户，我需要可视化界面来管理我的 Session Keys，查看使用情况。

**验收标准**：
- [ ] 创建 Session Key 表单
- [ ] Session Key 列表展示
- [ ] 使用情况可视化（进度条）
- [ ] 冻结/解冻操作
- [ ] 删除 Session Key

**技术要求**：
- React 组件
- shadcn/ui 组件库
- 实时数据更新（SWR）

**简化点**：
- 不支持批量操作
- 不支持权限配置界面（使用默认配置）
- 简单的使用情况展示（不支持图表）

---

## 3. 非功能性需求

### 3.1 性能要求
- HTTP 402 中间件响应时间 < 100ms
- 支持 1,000+ 并发会话
- 状态通道累积延迟 < 50ms

### 3.2 安全要求
- Session Key 权限最小化
- 所有链上操作需签名验证
- 规则引擎实时监控

### 3.3 可用性要求
- 系统可用性 > 99%
- 错误恢复时间 < 5 分钟

---

## 4. MVP 范围界定

### 包含功能 ✅
1. Session Key 智能合约
2. Session Key 管理服务（TypeScript）
3. HTTP 402 中间件（Node.js）
4. 状态通道累积器（Go）
5. 基础规则引擎（Go）
6. Session Key 管理界面（React）
7. 基础文档和示例

### 延后功能 ❌
1. ML 异常检测（v2）
2. 动态费率系统（v2）
3. Python SDK（v2）
4. Go SDK（v2）
5. 前端 Widget（v2）
6. 复杂规则配置（v2）
7. 密钥轮换（v2）
8. 批量操作（v2）

---

## 5. 技术架构（简化版）

```
┌─────────────────────────────────────────────────────────────┐
│                    用户层                                    │
├─────────────────────────────────────────────────────────────┤
│  Web App  │  AI Service (with HTTP 402 middleware)          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    API 层                                    │
├─────────────────────────────────────────────────────────────┤
│  /api/session-keys  │  HTTP 402 Middleware                  │
└─────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┼─────────────┐
                ▼             ▼             ▼
┌──────────────────┐  ┌──────────────┐  ┌──────────────┐
│  Session Key     │  │  Accumulator │  │  Rule Engine │
│  Service (TS)    │  │  (Go)        │  │  (Go)        │
└──────────────────┘  └──────────────┘  └──────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层                                    │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  Redis  │  Smart Contract (Polygon)         │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 实施计划

### Week 1-2: 智能合约和后端服务
- Week 1: Session Key 智能合约开发和测试
- Week 2: Session Key 管理服务（TypeScript）

### Week 3-4: 微支付网关和累积器
- Week 3: HTTP 402 中间件（Node.js）
- Week 4: 状态通道累积器（Go）

### Week 5: 规则引擎和前端
- Week 5: 基础规则引擎（Go）+ Session Key 管理界面

### Week 6: 集成测试和文档
- Week 6: 端到端测试 + 文档编写 + 示例项目

---

## 7. 成功指标

### 技术指标
- Session Key 创建成功率 > 95%
- HTTP 402 中间件响应时间 < 100ms
- 链上结算成功率 > 99%
- 规则引擎误报率 < 5%

### 业务指标
- 2-3 个早期客户试用
- 处理 10,000+ 微支付交易
- 用户反馈满意度 > 4/5
- 集成时间 < 1 小时

---

## 8. 风险与挑战

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 智能合约漏洞 | 高 | 代码审查 + 测试网充分测试 |
| Redis 数据丢失 | 中 | 持久化配置 + 定期备份 |
| 链上结算失败 | 中 | 重试机制 + 手动干预 |
| 用户体验复杂 | 低 | 简化流程 + 详细文档 |

---

## 9. 下一步行动

1. **Week 1**: 启动智能合约开发
2. **Week 2**: 开发 Session Key 管理服务
3. **Week 3**: 实现 HTTP 402 中间件
4. **Week 4**: 开发状态通道累积器
5. **Week 5**: 完成规则引擎和前端界面
6. **Week 6**: 集成测试和早期客户试用

---

## 10. 附录

### 10.1 MVP vs 完整版对比

| 功能 | MVP | 完整版 |
|------|-----|--------|
| Session Key 基础功能 | ✅ | ✅ |
| HTTP 402 中间件 | ✅ Node.js | ✅ Node.js/Python/Go |
| 状态通道累积 | ✅ 固定阈值 | ✅ 可配置阈值 |
| 规则引擎 | ✅ 3 个固定规则 | ✅ 自定义规则 |
| 异常检测 | ❌ | ✅ ML-based |
| 动态费率 | ❌ | ✅ |
| SDK | ❌ | ✅ 3 种语言 |
| 前端 Widget | ❌ | ✅ |
| 密钥轮换 | ❌ | ✅ |

### 10.2 早期客户画像

**理想客户**：
- AI 服务提供商（API 调用频繁）
- 已有加密货币支付需求
- 技术团队有 Web3 经验
- 愿意提供反馈和建议

**目标客户**：
- AI 聊天机器人服务商
- DePIN 项目（IoT 设备计费）
- GPU 算力租赁平台

### 10.3 反馈收集计划

**收集方式**：
- 每周视频会议
- 使用情况数据分析
- 问卷调查
- GitHub Issues

**关键问题**：
1. 集成难度如何？
2. 哪些功能最有价值？
3. 哪些功能缺失？
4. 性能是否满足需求？
5. 文档是否清晰？

