# 百分比分账功能 - 产品需求文档 (PRD)

## 文档信息

| 项目 | 内容 |
|------|------|
| 功能名称 | 百分比分账 (Split Payment) |
| 优先级 | P0 - 核心功能 |
| 版本 | v1.0 |
| 创建日期 | 2025-01-30 |
| 状态 | 待开发 |

---

## 1. 背景与目标

### 1.1 业务背景

Web3 团队经常需要将一笔资金按比例分配给多人：
- 项目收入按股份分配给合伙人
- 营销预算按绩效分配给 KOL
- DAO 金库按贡献度分配给成员

**当前痛点**：
- 手动计算每人金额，容易出错
- Excel 计算后逐笔转账，效率低
- 无法保存分账规则，每次重复操作

### 1.2 产品目标

> 让用户输入一个总金额 + 分账规则，一键完成批量分账

**核心价值**：
1. 自动计算 - 输入总额和百分比，自动算出每人金额
2. 规则复用 - 保存常用分账模板
3. 透明可审计 - 链上执行，记录完整

### 1.3 成功指标

| 指标 | 目标值 |
|------|--------|
| 分账创建成功率 | > 99% |
| 平均操作时间 | < 2 分钟 |
| 用户模板复用率 | > 50% |

---

## 2. 用户故事

### 2.1 核心场景

**场景 A：项目收入分账**
> 作为 Web3 项目创始人，我收到一笔 10,000 USDC 的收入，需要按照 40%/30%/30% 的比例分给三位合伙人，希望能一键完成分账，不需要手动计算每人金额。

**场景 B：KOL 推广费分配**
> 作为市场负责人，我有 5,000 USDC 的推广预算，需要根据各 KOL 的粉丝数占比分配，希望系统自动计算并支付。

**场景 C：DAO 贡献者奖励**
> 作为 DAO 财务，我需要每月将金库资金按贡献点数分配给 50+ 成员，希望能导入 CSV 批量处理。

### 2.2 用户角色

| 角色 | 描述 | 核心诉求 |
|------|------|---------|
| 项目创始人 | 小团队，2-5人 | 简单快速，可复用 |
| 财务负责人 | 中型团队，10-50人 | 批量处理，可导出报表 |
| DAO 财务 | 大型 DAO，50-500人 | 批量导入，审计追踪 |

---

## 3. 功能设计

### 3.1 分账模式

支持三种分账模式：

| 模式 | 描述 | 适用场景 |
|------|------|---------|
| 百分比模式 | 输入总额，按百分比分配 | 合伙人分成 |
| 固定金额模式 | 每人指定固定金额 | 工资发放 |
| 混合模式 | 部分固定 + 剩余按比例 | 底薪+提成 |

### 3.2 功能流程

```
┌─────────────────────────────────────────────────────────────┐
│                    分账功能主流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 选择模式    2. 配置规则    3. 预览确认    4. 执行支付   │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐    │
│  │百分比   │──▶│总额:10000│──▶│ A: 4000 │──▶│ 签名    │    │
│  │固定金额 │   │A: 40%   │   │ B: 3000 │   │ 执行    │    │
│  │混合    │   │B: 30%   │   │ C: 3000 │   │ 完成    │    │
│  └─────────┘   │C: 30%   │   └─────────┘   └─────────┘    │
│                └─────────┘                                  │
│                     │                                       │
│                     ▼                                       │
│               ┌─────────┐                                   │
│               │保存模板 │（可选）                            │
│               └─────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 核心功能点

#### 3.3.1 分账规则编辑器

**输入字段**：
- 总金额 (必填，当模式为百分比时)
- 代币类型 (USDC/USDT/DAI)
- 收款人列表：
  - 钱包地址 (必填)
  - 名称/备注 (选填)
  - 百分比 或 固定金额 (必填)

**验证规则**：
- 百分比模式：所有百分比之和必须 = 100%
- 固定金额模式：总额 >= 所有固定金额之和
- 混合模式：固定金额 + 百分比部分 = 总额

**精度处理**：
- 金额保留 6 位小数（USDC 精度）
- 四舍五入误差分配给最后一人
- 示例：10000 分 33.33%/33.33%/33.34% = 3333/3333/3334

#### 3.3.2 批量导入

支持 CSV/Excel 导入，新增列：
- `percentage` - 百分比 (例如 "40" 或 "40%")
- `split_mode` - 分配模式 ("percentage" / "fixed")

**示例 CSV**：
```csv
address,name,percentage
0x123...,Alice,40
0x456...,Bob,35
0x789...,Charlie,25
```

#### 3.3.3 分账模板

**模板功能**：
- 保存常用分账规则
- 命名模板（如 "合伙人分成"、"月度 KOL"）
- 快速加载应用
- 支持编辑、删除

**模板存储**：
- 用户级别（每个钱包地址独立）
- 最多保存 20 个模板

#### 3.3.4 执行与记录

**执行选项**：
- 立即执行
- 定时执行（关联定时发薪功能）
- 多签审批（关联权限系统）

**记录信息**：
- 分账 ID
- 总金额、代币、链
- 收款人明细（地址、比例、实际金额）
- 执行时间、交易哈希
- 状态（成功/失败/部分成功）

---

## 4. 界面设计

### 4.1 入口

在现有批量支付页面 (`/batch-payment`) 添加模式切换：
- Tab 1: 批量支付（现有）
- Tab 2: 分账支付（新增）

### 4.2 分账支付界面

```
┌─────────────────────────────────────────────────────────────┐
│  分账支付                                          [保存模板] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  分账模式:  ○ 百分比  ○ 固定金额  ○ 混合                     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 总金额   [__________] USDC ▼                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  收款人 (3)                              [+ 添加] [导入CSV]  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 0x123...abc    Alice      [40] %    = 4,000.00  │ ✕ │
│  │ 2. 0x456...def    Bob        [35] %    = 3,500.00  │ ✕ │
│  │ 3. 0x789...ghi    Charlie    [25] %    = 2,500.00  │ ✕ │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  百分比合计: 100% ✓        金额合计: 10,000.00 USDC         │
│                                                             │
│  ────────────────────────────────────────────────────────  │
│                                                             │
│  预估 Gas: ~0.003 ETH                                       │
│  平台费用: 0.2% = 20 USDC                                   │
│                                                             │
│                            [预览] [执行分账]                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 模板管理

```
┌─────────────────────────────────────────────────────────────┐
│  我的分账模板                                    [+ 新建模板] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📋 合伙人分成                                        │   │
│  │    3 人 · 40%/35%/25%                     [使用] [编辑]│   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 📋 月度 KOL 奖励                                     │   │
│  │    8 人 · 按粉丝数占比                    [使用] [编辑]│   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 📋 开发团队工资                                      │   │
│  │    5 人 · 固定金额                        [使用] [编辑]│   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 边界情况

### 5.1 异常处理

| 情况 | 处理方式 |
|------|---------|
| 百分比总和 ≠ 100% | 前端校验，禁止提交 |
| 计算结果有精度误差 | 差额加到最后一人 |
| 部分转账失败 | 标记失败项，允许重试 |
| 收款地址无效 | 前端校验 + 后端双重验证 |
| Gas 不足 | 提前估算，提示用户 |

### 5.2 限制条件

| 项目 | 限制 | 原因 |
|------|------|------|
| 最大收款人数 | 100 人/次 | Gas 限制 + 性能 |
| 最小金额 | 0.01 USDC | 避免粉尘交易 |
| 最大模板数 | 20 个 | 存储成本 |
| 百分比精度 | 2 位小数 | 0.01% 最小单位 |

---

## 6. 数据需求

### 6.1 新增数据字段

**split_payments 表**：
- id (主键)
- creator_address (创建者钱包)
- total_amount (总金额)
- token (代币)
- chain_id (链 ID)
- split_mode (模式: percentage/fixed/hybrid)
- rules (JSON: 分账规则)
- status (状态)
- created_at, executed_at

**split_templates 表**：
- id (主键)
- owner_address (所有者钱包)
- name (模板名称)
- rules (JSON: 分账规则)
- created_at, updated_at

详细设计见 [DATABASE.md](./DATABASE.md)

---

## 7. API 需求

| API | 方法 | 描述 |
|-----|------|------|
| /api/split-payment | POST | 创建分账任务 |
| /api/split-payment | GET | 获取分账历史 |
| /api/split-payment/calculate | POST | 计算分账金额 |
| /api/split-payment/execute | POST | 执行分账 |
| /api/split-templates | GET/POST/PUT/DELETE | 模板 CRUD |

详细设计见 [API.md](./API.md)

---

## 8. 发布计划

### 8.1 MVP 范围

- [x] 百分比模式基础功能
- [x] 手动输入收款人
- [x] CSV 导入
- [x] 执行记录
- [ ] 模板保存（可放 v1.1）

### 8.2 后续迭代

- v1.1: 模板管理、混合模式
- v1.2: 定时分账、审批流程
- v1.3: 多签集成

---

## 9. 风险与依赖

### 9.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 大批量执行超时 | 中 | 分批执行 + 进度显示 |
| 精度计算误差 | 低 | 使用 BigNumber |

### 9.2 依赖项

- 现有批量支付功能正常
- 钱包连接功能正常
- Supabase 数据库可用

---

**审核人**: _待定_
**批准日期**: _待定_
