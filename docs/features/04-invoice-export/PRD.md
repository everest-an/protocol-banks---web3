# 账单导出功能 - 产品需求文档 (PRD)

## 文档信息

| 项目 | 内容 |
|------|------|
| 功能名称 | 账单导出 (Invoice Export) |
| 优先级 | P1 - 重要功能 |
| 版本 | v1.0 |
| 创建日期 | 2025-01-30 |
| 状态 | 待开发 |

---

## 1. 背景与目标

### 1.1 业务背景

Web3 团队需要向会计/税务提供支付记录：
- 月度/季度支付汇总
- 带公司抬头的专业账单
- 可追溯的交易证明

**当前痛点**：
- 只有 CSV 导出，格式简单
- 无法生成专业 PDF 账单
- 缺少汇总统计

### 1.2 产品目标

> 一键生成专业格式的 PDF 账单，满足财务合规需求

---

## 2. 功能设计

### 2.1 导出格式

| 格式 | 用途 | 内容 |
|------|------|------|
| **CSV** | 数据分析 | 原始交易明细 |
| **Excel** | 会计处理 | 明细 + 汇总表 |
| **PDF** | 存档/报告 | 专业格式账单 |

### 2.2 报告类型

| 类型 | 内容 | 适用场景 |
|------|------|---------|
| 交易明细 | 所有交易记录 | 审计 |
| 月度汇总 | 按月统计 | 月报 |
| 收款人汇总 | 按收款人分组 | 供应商对账 |
| 支付凭证 | 单笔交易证明 | 报销 |

### 2.3 PDF 账单设计

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  [公司 Logo]                                                    │
│                                                                 │
│  PAYMENT REPORT                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  From: Protocol Banks                    Date: 2025-01-30       │
│  Wallet: 0x123...abc                     Period: Jan 2025       │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  SUMMARY                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Total Payments: 15                                       │   │
│  │ Total Amount: 45,000.00 USDC                            │   │
│  │ Unique Recipients: 8                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  TRANSACTIONS                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Date       │ Recipient      │ Amount    │ Tx Hash      │   │
│  ├────────────┼────────────────┼───────────┼──────────────┤   │
│  │ 2025-01-01 │ 0x456...def    │ 3,000.00  │ 0xabc...     │   │
│  │ 2025-01-01 │ 0x789...ghi    │ 3,500.00  │ 0xdef...     │   │
│  │ ...        │ ...            │ ...       │ ...          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  Generated by Protocol Banks · https://protocolbanks.com        │
│  Verify on-chain: All transactions are verifiable on blockchain │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 界面设计

### 3.1 导出入口

在历史记录页面和分析页面添加导出按钮：

```
┌─────────────────────────────────────────────────────────────────┐
│  交易历史                                           [导出 ▼]    │
├─────────────────────────────────────────────────────────────────┤
│                                              ┌─────────────────┐│
│  筛选: 2025年1月 ▼  所有类型 ▼  所有状态 ▼  │ 📄 导出 CSV     ││
│                                              │ 📊 导出 Excel   ││
│  [交易列表...]                               │ 📑 导出 PDF     ││
│                                              │ ───────────────  ││
│                                              │ 📋 月度报告     ││
│                                              │ 📋 收款人汇总   ││
│                                              └─────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 导出设置弹窗

```
┌─────────────────────────────────────────────────────────────────┐
│  导出报告                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  时间范围                                                        │
│  ○ 本月  ○ 上月  ○ 本季度  ● 自定义                             │
│  [2025-01-01] 至 [2025-01-31]                                   │
│                                                                 │
│  报告类型                                                        │
│  ● 交易明细  ○ 月度汇总  ○ 收款人汇总                           │
│                                                                 │
│  导出格式                                                        │
│  ○ CSV  ○ Excel  ● PDF                                          │
│                                                                 │
│  PDF 设置（仅 PDF 格式）                                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 公司名称: [Protocol Banks Inc.]                           │ │
│  │ 公司地址: [123 Web3 Street, Crypto City]                  │ │
│  │ □ 包含公司 Logo                                           │ │
│  │ □ 包含交易哈希二维码                                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  预览: 将导出 15 笔交易，总计 45,000.00 USDC                    │
│                                                                 │
│                                     [取消]  [预览]  [下载]       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 技术实现

### 4.1 技术方案

| 格式 | 技术 | 说明 |
|------|------|------|
| CSV | 原生 JS | 现有实现 |
| Excel | xlsx 库 | 支持多 sheet |
| PDF | @react-pdf/renderer | React 组件生成 |

### 4.2 API 设计

```typescript
// POST /api/reports/generate
interface GenerateReportRequest {
  type: 'transactions' | 'monthly' | 'recipient';
  format: 'csv' | 'excel' | 'pdf';
  startDate: string;
  endDate: string;
  walletAddress: string;
  pdfOptions?: {
    companyName?: string;
    companyAddress?: string;
    includeLogo?: boolean;
    includeQRCode?: boolean;
  };
}

interface GenerateReportResponse {
  success: boolean;
  downloadUrl: string;  // 临时下载链接
  expiresAt: string;
  summary: {
    totalTransactions: number;
    totalAmount: number;
    token: string;
  };
}
```

### 4.3 PDF 组件

```typescript
// components/reports/PaymentReportPDF.tsx
import { Document, Page, Text, View, StyleSheet } from '@react-pdf/renderer';

export function PaymentReportPDF({ data, options }) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        <View style={styles.header}>
          {options.includeLogo && <Image src="/logo.png" />}
          <Text style={styles.title}>PAYMENT REPORT</Text>
        </View>

        <View style={styles.summary}>
          <Text>Total Payments: {data.totalCount}</Text>
          <Text>Total Amount: {data.totalAmount} {data.token}</Text>
        </View>

        <View style={styles.table}>
          {data.transactions.map(tx => (
            <View key={tx.id} style={styles.row}>
              <Text>{tx.date}</Text>
              <Text>{tx.recipient}</Text>
              <Text>{tx.amount}</Text>
            </View>
          ))}
        </View>
      </Page>
    </Document>
  );
}
```

---

## 5. 数据库设计

### 5.1 报告记录表

```sql
CREATE TABLE report_exports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wallet_address VARCHAR(42) NOT NULL,
  report_type VARCHAR(20) NOT NULL,
  format VARCHAR(10) NOT NULL,
  date_range_start DATE NOT NULL,
  date_range_end DATE NOT NULL,
  file_url TEXT,
  file_size INTEGER,
  transaction_count INTEGER,
  total_amount DECIMAL(36, 18),
  status VARCHAR(20) DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE,

  CONSTRAINT valid_format CHECK (format IN ('csv', 'excel', 'pdf'))
);

CREATE INDEX idx_report_exports_wallet ON report_exports(wallet_address);
```

---

## 6. 实现计划

### MVP 范围

- [x] CSV 导出（已有）
- [ ] Excel 导出（多 sheet）
- [ ] PDF 导出（基础模板）
- [ ] 月度汇总报告
- [ ] 公司信息自定义

### 后续迭代

- v1.1: 收款人汇总报告
- v1.1: 多语言模板
- v1.2: 邮件定时发送报告
- v1.2: 品牌定制（Logo、颜色）

---

## 7. 依赖

```json
{
  "dependencies": {
    "@react-pdf/renderer": "^3.1.0",
    "xlsx": "^0.18.5"
  }
}
```

---

**最后更新**: 2025-01-30
