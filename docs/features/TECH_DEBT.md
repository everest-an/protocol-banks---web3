# æŠ€æœ¯å€ºåŠ¡æ¸…å•

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½• Protocol Banks é¡¹ç›®ä¸­å·²è¯†åˆ«çš„æŠ€æœ¯å€ºåŠ¡ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå®šæœŸè¯„å®¡å¹¶åˆ¶å®šå¿è¿˜è®¡åˆ’ã€‚

---

## ç°æœ‰æŠ€æœ¯å€ºåŠ¡

### TD-001: æ‰¹é‡æ”¯ä»˜ä¸²è¡Œæ‰§è¡Œï¼ˆå·²è§£å†³ âœ…ï¼‰

**ä½ç½®**: `lib/services/payment-service.ts`

**é—®é¢˜æè¿°**: åŸå®ç°ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæ¯ç¬”é—´éš” 1 ç§’

**è§£å†³æ–¹æ¡ˆ**: å·²å®ç°å¹¶è¡Œæ‰§è¡Œ

**ä¿®æ”¹å†…å®¹**:
1. æ–°å¢ `lib/utils/concurrency.ts` - é€šç”¨å¹¶å‘æ§åˆ¶å·¥å…·
2. ä¿®æ”¹ `processBatchPayments` å‡½æ•°ä¸ºå¹¶è¡Œæ‰§è¡Œ
3. æ–°å¢ `BatchPaymentOptions` é…ç½®é¡¹
4. æ–°å¢ `Recipient` å’Œ `PaymentResult` ç±»å‹

**é…ç½®å‚æ•°**:
- `concurrency`: æœ€å¤§å¹¶å‘æ•°ï¼ˆé»˜è®¤ 5ï¼‰
- `batchDelay`: æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆé»˜è®¤ 200msï¼‰
- `timeout`: å•ç¬”è¶…æ—¶ï¼ˆé»˜è®¤ 60sï¼‰
- `retries`: å¤±è´¥é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 1ï¼‰

**æ€§èƒ½æå‡**:
- 100 äººæ‰¹é‡æ”¯ä»˜ï¼š100+ ç§’ â†’ ~25 ç§’ï¼ˆå¹¶å‘ 5ï¼‰
- æ”¯æŒè‡ªå®šä¹‰å¹¶å‘æ•°ï¼Œæœ€é«˜å¯è¾¾ 10-20 å¹¶å‘

**è§£å†³æ—¥æœŸ**: 2025-01-30

---

### TD-002: ç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼ˆå·²è§£å†³ âœ…ï¼‰

**ä½ç½®**: å¤šå¤„ API è·¯ç”±å’ŒæœåŠ¡

**é—®é¢˜æè¿°**:
- é”™è¯¯ä¿¡æ¯ä¸ç»Ÿä¸€
- ç¼ºå°‘é”™è¯¯ç 
- å‰ç«¯éš¾ä»¥åšé’ˆå¯¹æ€§å¤„ç†

**è§£å†³æ–¹æ¡ˆ**: å·²å®ç°ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿ

**ä¿®æ”¹å†…å®¹**:
1. æ–°å¢ `lib/errors/index.ts` - é”™è¯¯ç ã€æ¶ˆæ¯ã€HTTP çŠ¶æ€æ˜ å°„
2. æ–°å¢ `lib/errors/api-handler.ts` - API åŒ…è£…å™¨å’ŒéªŒè¯åŠ©æ‰‹
3. é‡æ„è®¢é˜… API è·¯ç”±ä½¿ç”¨æ–°ç³»ç»Ÿ

**ç‰¹æ€§**:
- 30+ é”™è¯¯ç±»å‹ï¼ˆAuthã€Validationã€Paymentã€Blockchain ç­‰ï¼‰
- åŒè¯­æ”¯æŒï¼ˆè‹±æ–‡/ä¸­æ–‡ï¼‰
- è‡ªåŠ¨ HTTP çŠ¶æ€ç æ˜ å°„
- `withErrorHandling` API åŒ…è£…å™¨
- éªŒè¯åŠ©æ‰‹ï¼ˆvalidateAddressã€validateRequired ç­‰ï¼‰

**è§£å†³æ—¥æœŸ**: 2025-01-30

---

### TD-003: è®¢é˜…æœåŠ¡ç¼ºå°‘æ‰§è¡Œå™¨ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `lib/services/subscription-service.ts:446-448`

**é—®é¢˜æè¿°**:
```typescript
// TODO: Schedule retry after 24 hours
// TODO: Send notification to user
```

**å½±å“**:
- è®¢é˜…åŠŸèƒ½æ— æ³•è‡ªåŠ¨æ‰§è¡Œ
- æ”¯ä»˜å¤±è´¥æ— é‡è¯•
- ç”¨æˆ·æ— é€šçŸ¥

**è§£å†³æ–¹æ¡ˆ**:
- æœ¬æ¬¡ P0 åŠŸèƒ½ã€Œå®šæ—¶å‘è–ªã€å°†è§£å†³æ­¤å€ºåŠ¡

**é¢„è®¡å·¥ä½œé‡**: 3-5 å¤©ï¼ˆåŒ…å«åœ¨å®šæ—¶å‘è–ªåŠŸèƒ½ä¸­ï¼‰

---

### TD-004: Rain Card æˆæƒæ£€æŸ¥æœªå®ç°ï¼ˆå·²è§£å†³ âœ…ï¼‰

**ä½ç½®**: `services/webhook-handler/internal/handler/rain.go`

**é—®é¢˜æè¿°**: æˆæƒæ£€æŸ¥ç›´æ¥è¿”å›ç¡¬ç¼–ç  "approved"ï¼Œå­˜åœ¨å®‰å…¨é£é™©

**è§£å†³æ–¹æ¡ˆ**: å·²å®ç°å®Œæ•´æˆæƒæ£€æŸ¥

**ä¿®æ”¹å†…å®¹**:
1. ä¿®æ”¹ `checkAuthorization` å®ç°å®Œæ•´æˆæƒé€»è¾‘
2. æ–°å¢ `store.GetCardUserInfo` è·å–å¡ç”¨æˆ·ä¿¡æ¯
3. æ–°å¢ `store.IsMerchantBlacklisted` å•†æˆ·é»‘åå•æ£€æŸ¥
4. æ–°å¢ `store.RecordAuthorization` æˆæƒè®°å½•
5. æ–°å¢æ•°æ®åº“è¿ç§» `2025-01-30_rain_card_tables.sql`

**æˆæƒæ£€æŸ¥é¡¹**:
- å¡æ¿€æ´»çŠ¶æ€éªŒè¯
- ä½™é¢å……è¶³æ€§æ£€æŸ¥
- å•ç¬”äº¤æ˜“é™é¢æ£€æŸ¥
- æ—¥æ¶ˆè´¹é™é¢æ£€æŸ¥
- æœˆæ¶ˆè´¹é™é¢æ£€æŸ¥
- å•†æˆ·é»‘åå•éªŒè¯

**å®‰å…¨è®¾è®¡**: æŸ¥è¯¢å¤±è´¥æ—¶æ‹’ç»äº¤æ˜“ï¼ˆFail-safeï¼‰

**è§£å†³æ—¥æœŸ**: 2025-01-30

---

### TD-005: å‰ç«¯çŠ¶æ€ç®¡ç†åˆ†æ•£ï¼ˆå·²è§£å†³ âœ…ï¼‰

**ä½ç½®**: å¤šä¸ªé¡µé¢ç»„ä»¶

**é—®é¢˜æè¿°**:
- ä½¿ç”¨ useState ç®¡ç†å¤æ‚çŠ¶æ€
- æ— å…¨å±€çŠ¶æ€ç®¡ç†
- æ•°æ®è·å–é€»è¾‘åˆ†æ•£

**è§£å†³æ–¹æ¡ˆ**: å·²å®ç° Zustand + SWR çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

**ä¿®æ”¹å†…å®¹**:

1. æ–°å¢ `lib/stores/ui-store.ts` - UI çŠ¶æ€ç®¡ç†
   - ä¾§è¾¹æ çŠ¶æ€
   - å…¨å±€ loading
   - Modal ç®¡ç†
   - Toast é€šçŸ¥é˜Ÿåˆ—
   - Demo æ¨¡å¼

2. æ–°å¢ `lib/stores/wallet-store.ts` - é’±åŒ…çŠ¶æ€ç®¡ç†
   - è¿æ¥çŠ¶æ€
   - ä½™é¢ç®¡ç†
   - æœ€è¿‘åœ°å€å†å²

3. æ–°å¢ `lib/hooks/use-payments.ts` - æ”¯ä»˜æ•°æ®è·å–
   - usePayments - æ”¯ä»˜åˆ—è¡¨
   - useBatchPayments - æ‰¹é‡æ”¯ä»˜
   - usePaymentStats - ç»Ÿè®¡æ•°æ®

4. æ–°å¢ `lib/hooks/use-merchants.ts` - å•†æˆ·æ•°æ®è·å–
   - useMerchants - å•†æˆ·åˆ—è¡¨
   - useCreateMerchant - åˆ›å»ºå•†æˆ·
   - useMerchantStats - å•†æˆ·ç»Ÿè®¡

5. æ–°å¢ `lib/hooks/use-orders.ts` - è®¢å•æ•°æ®è·å–
   - useOrders - è®¢å•åˆ—è¡¨
   - useCreateOrder - åˆ›å»ºè®¢å•
   - useCheckout - æ”¶é“¶å°çŠ¶æ€

**ç‰¹æ€§**:
- Zustand å…¨å±€çŠ¶æ€ï¼ˆæŒä¹…åŒ–ã€DevToolsï¼‰
- SWR æ•°æ®è·å–ï¼ˆè‡ªåŠ¨é‡éªŒè¯ã€å»é‡ã€ç¼“å­˜ï¼‰
- TypeScript ç±»å‹å®‰å…¨
- æŒ‰æ¨¡å—å¯¼å‡º hooks

**è§£å†³æ—¥æœŸ**: 2025-01-30

---

### TD-006: æ•°æ®åº“è¡¨ç¼ºå°‘ç´¢å¼•ä¼˜åŒ–ï¼ˆå·²è§£å†³ âœ…ï¼‰

**ä½ç½®**: Supabase æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**: å·²åˆ›å»ºç´¢å¼•è¿ç§»è„šæœ¬

**è¿ç§»è„šæœ¬**: `scripts/migrations/2025-01-30_add_indexes.sql`

**æ·»åŠ çš„ç´¢å¼•**:
- payments: created_by, created_at, status, å¤åˆç´¢å¼•
- batch_payments: from_address, status, created_at
- subscriptions: created_by, next_payment (æ´»è·ƒ), status
- transactions: from_address, to_address, tx_hash
- vendors: owner_address, status

**æ‰§è¡Œæ–¹å¼**: åœ¨ Supabase SQL Editor ä¸­è¿è¡Œè„šæœ¬

**è§£å†³æ—¥æœŸ**: 2025-01-30

---

### TD-007: ç¼ºå°‘å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆè¿›è¡Œä¸­ ğŸ”„ï¼‰

**ä½ç½®**: æ•´ä¸ªé¡¹ç›®

**é—®é¢˜æè¿°**:
- å‰ç«¯ç»„ä»¶æ— æµ‹è¯•
- æœåŠ¡å±‚æµ‹è¯•ä¸å®Œæ•´
- CI æ— æµ‹è¯•é—¨ç¦

**å½±å“**:
- é‡æ„é£é™©é«˜
- å›å½’éš¾å‘ç°

**è§£å†³æ–¹æ¡ˆ**:
- æ ¸å¿ƒæœåŠ¡æ·»åŠ å•å…ƒæµ‹è¯•
- å…³é”®æµç¨‹æ·»åŠ é›†æˆæµ‹è¯•
- CI æ·»åŠ æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥

**å½“å‰è¿›åº¦**:

| æ¨¡å— | æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|------|---------|---------|------|
| é”™è¯¯å¤„ç†ç³»ç»Ÿ | `lib/__tests__/errors.test.ts` | 37 | âœ… |
| UI Store | `lib/__tests__/stores.test.ts` | 12 | âœ… |
| Wallet Store | `lib/__tests__/stores.test.ts` | 17 | âœ… |
| å¹¶å‘å·¥å…· | `lib/__tests__/concurrency.test.ts` | 21 | âœ… |
| SWR Hooks | `lib/__tests__/hooks.test.ts` | 20 | âœ… |
| API Keys Hook | `hooks/__tests__/use-api-keys.test.ts` | 10 | âœ… |
| Subscriptions Hook | `hooks/__tests__/use-subscriptions.test.ts` | 11 | âœ… |
| Webhooks Hook | `hooks/__tests__/use-webhooks.test.ts` | 10 | âœ… |
| Dashboard Activity | `hooks/__tests__/use-dashboard-activity.test.ts` | 15 | âœ… |

**æ€»è®¡**: 581 ä¸ªæµ‹è¯•ï¼Œ30 ä¸ªæµ‹è¯•å¥—ä»¶å…¨éƒ¨é€šè¿‡

**æµ‹è¯•è¦†ç›–èŒƒå›´**:
- âœ… é”™è¯¯å¤„ç†ï¼ˆErrorCodes, ApiError, è¾…åŠ©å‡½æ•°ï¼‰
- âœ… çŠ¶æ€ç®¡ç†ï¼ˆUI Store, Wallet Storeï¼‰
- âœ… å¹¶å‘æ§åˆ¶ï¼ˆrunConcurrent, é‡è¯•, è¶…æ—¶ï¼‰
- âœ… æ•°æ®è·å– Hooksï¼ˆorders, merchants, paymentsï¼‰
- âœ… æœåŠ¡å±‚ï¼ˆpayment-service, subscription-service, vendor-payment-serviceï¼‰
- â³ React ç»„ä»¶æµ‹è¯•
- â³ E2E æµ‹è¯•

**é¢„è®¡å·¥ä½œé‡**: æŒç»­è¿›è¡Œ

---

### TD-008: Payout Engine ç§é’¥ç®¡ç†ä¸å®‰å…¨ï¼ˆå·²è§£å†³ âœ…ï¼‰

**ä½ç½®**: `services/payout-engine/internal/service/payout.go`

**é—®é¢˜æè¿°**: `signTransaction` ä½¿ç”¨ç¡¬ç¼–ç ç©ºå­—ç¬¦ä¸²ï¼Œæ— æ³•æ‰§è¡Œäº¤æ˜“ç­¾å

**è§£å†³æ–¹æ¡ˆ**: å·²å®ç° KMSï¼ˆå¯†é’¥ç®¡ç†æœåŠ¡ï¼‰é›†æˆ

**ä¿®æ”¹å†…å®¹**:

1. æ–°å¢ `services/payout-engine/internal/kms/` åŒ…
2. å®ç° `Signer` æ¥å£æ”¯æŒå¤šç§ KMS æä¾›å•†
3. æ›´æ–° `PayoutService` ä½¿ç”¨ KMS ç­¾åå™¨
4. æ›´æ–°é…ç½®æ”¯æŒ KMS ç¯å¢ƒå˜é‡

**æ”¯æŒçš„ KMS æä¾›å•†**:

- `local`: æœ¬åœ°ç§é’¥ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
- `aws`: AWS Key Management Service
- `gcp`: Google Cloud KMS
- `vault`: HashiCorp Vault Transit

**ç¯å¢ƒå˜é‡**:

- `KMS_PROVIDER`: é€‰æ‹©æä¾›å•†
- `PAYOUT_PRIVATE_KEY`: æœ¬åœ°ç§é’¥ï¼ˆå¼€å‘ï¼‰
- `AWS_REGION`, `AWS_KMS_KEY_ID`: AWS é…ç½®
- `VAULT_ADDR`, `VAULT_TOKEN`, `VAULT_KEY_NAME`: Vault é…ç½®

**è§£å†³æ—¥æœŸ**: 2025-01-30

---

## å€ºåŠ¡å¿è¿˜è®¡åˆ’

| çŠ¶æ€ | é¡¹ç›® | è¯´æ˜ |
|------|------|------|
| âœ… å·²å®Œæˆ | TD-001, TD-003, TD-006 | æ‰¹é‡æ”¯ä»˜ã€è®¢é˜…æ‰§è¡Œã€æ•°æ®åº“ç´¢å¼• |
| âœ… å·²å®Œæˆ | TD-002, TD-004, TD-008 | é”™è¯¯å¤„ç†ã€Rain Cardã€KMS é›†æˆ |
| âœ… å·²å®Œæˆ | TD-005 | å‰ç«¯çŠ¶æ€ç®¡ç†ï¼ˆZustand + SWRï¼‰ |
| å¾…å¤„ç† | TD-007 | å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆæŒç»­è¿›è¡Œï¼‰ |

---

## æ–°å¢å€ºåŠ¡æµç¨‹

1. å‘ç°å€ºåŠ¡æ—¶ç«‹å³è®°å½•åˆ°æœ¬æ–‡æ¡£
2. è¯„ä¼°ä¼˜å…ˆçº§å’Œå·¥ä½œé‡
3. å‘¨ä¼šè¯„å®¡æ˜¯å¦çº³å…¥å½“å‰è¿­ä»£
4. å¿è¿˜åæ›´æ–°çŠ¶æ€ä¸ºã€Œå·²è§£å†³ã€

---

**æœ€åæ›´æ–°**: 2025-01-30
