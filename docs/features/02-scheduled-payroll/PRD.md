# 定时发薪功能 - 产品需求文档 (PRD)

## 文档信息

| 项目 | 内容 |
|------|------|
| 功能名称 | 定时发薪 (Scheduled Payroll) |
| 优先级 | P0 - 核心功能 |
| 版本 | v1.0 |
| 创建日期 | 2025-01-30 |
| 状态 | 待开发 |
| 依赖 | 百分比分账功能 |

---

## 1. 背景与目标

### 1.1 业务背景

Web3 团队需要定期支付：
- 每月固定日期给员工发工资
- 每周给贡献者发放奖励
- 每月给 KOL 结算推广费

**当前痛点**：
- 需要人工记住发薪日期
- 每次都要重复操作
- 容易遗忘或延迟
- 现有订阅功能只有 UI，无自动执行

### 1.2 产品目标

> 设置一次，自动按时发薪，无需人工干预

**核心价值**：
1. 自动执行 - 到期自动触发支付
2. 灵活配置 - 支持多种发薪周期
3. 安全可控 - 支持审批流程和限额

### 1.3 成功指标

| 指标 | 目标值 |
|------|--------|
| 定时任务准时率 | > 99% |
| 自动执行成功率 | > 95% |
| 用户设置完成率 | > 80% |

---

## 2. 用户故事

### 2.1 核心场景

**场景 A：月度工资发放**
> 作为创始人，我希望每月 1 号自动给 5 名员工发放 USDC 工资，不需要每次手动操作。

**场景 B：周薪/双周薪**
> 作为 DAO 财务，我希望每两周自动给贡献者发放奖励，系统提前通知我确认。

**场景 C：带审批的大额支付**
> 作为财务总监，我希望超过 5000 USDC 的定时支付需要我审批后才执行。

### 2.2 用户角色

| 角色 | 描述 | 核心诉求 |
|------|------|---------|
| 小团队创始人 | 1-5 人 | 简单设置，全自动 |
| 财务负责人 | 中型团队 | 审批流程，报表 |
| DAO 核心成员 | 大型 DAO | 多签集成，透明 |

---

## 3. 功能设计

### 3.1 发薪周期

| 周期类型 | 说明 | 示例 |
|---------|------|------|
| 每日 | 每天固定时间 | 每天 09:00 UTC |
| 每周 | 每周固定日期 | 每周一 |
| 双周 | 每两周 | 每隔一周五 |
| 每月 | 每月固定日期 | 每月 1 号、15 号 |
| 自定义 | Cron 表达式 | 高级用户 |

### 3.2 执行模式

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| 自动执行 | 到期直接执行 | 信任度高，小额 |
| 通知确认 | 提前通知，用户确认后执行 | 中等金额 |
| 审批执行 | 需要指定人审批 | 大额支付 |

### 3.3 功能流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    定时发薪主流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 创建发薪计划                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 选择收款人（手动/导入/模板）                              │   │
│  │ 设置金额（固定/百分比）                                   │   │
│  │ 配置周期（每月/每周/...）                                 │   │
│  │ 选择执行模式（自动/通知/审批）                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  2. 系统调度                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Cron Job 每小时检查到期任务                               │   │
│  │ 找到到期任务 → 触发执行流程                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  3. 执行/审批                                                   │
│  ┌───────────┬───────────┬───────────┐                        │
│  │ 自动执行  │ 通知确认  │ 审批流程  │                        │
│  │     │     │     │     │     │     │                        │
│  │     ▼     │     ▼     │     ▼     │                        │
│  │ 直接支付  │ 等待确认  │ 等待审批  │                        │
│  └───────────┴───────────┴───────────┘                        │
│                              │                                  │
│                              ▼                                  │
│  4. 结果处理                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 记录执行结果 → 发送通知 → 计算下次执行时间                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 核心功能点

#### 3.4.1 发薪计划管理

**创建计划**：
- 计划名称（如 "月度工资"）
- 收款人列表（关联分账功能）
- 发薪周期配置
- 执行模式选择
- 限额设置（可选）

**计划状态**：
- `active` - 正常运行
- `paused` - 暂停
- `expired` - 已过期
- `cancelled` - 已取消

#### 3.4.2 执行调度器

**调度机制**：
- 使用 Vercel Cron 或外部调度器
- 每小时检查一次到期任务
- 支持时区配置（默认 UTC）

**执行窗口**：
- 允许执行窗口：设定时间 ± 1 小时
- 超过窗口标记为 `missed`
- 支持手动补发

#### 3.4.3 通知系统

**通知类型**：
| 事件 | 通知内容 |
|------|---------|
| 即将执行 | "发薪计划将在 24 小时后执行" |
| 待确认 | "请确认执行本次发薪" |
| 执行成功 | "发薪完成，共支付 X USDC" |
| 执行失败 | "发薪失败，请检查余额" |
| 需要审批 | "有一笔发薪需要您审批" |

**通知渠道**：
- 站内通知（必须）
- Email（可选，使用 Resend）
- Webhook（可选，给开发者）

#### 3.4.4 执行记录

每次执行记录：
- 执行 ID
- 关联计划 ID
- 计划执行时间 vs 实际执行时间
- 收款人明细
- 执行状态和结果
- 交易哈希

---

## 4. 界面设计

### 4.1 入口

在主导航添加 "Payroll" 或在现有 Subscriptions 页面扩展

### 4.2 发薪计划列表

```
┌─────────────────────────────────────────────────────────────────┐
│  定时发薪                                          [+ 创建计划]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 📅 月度工资                                      [Active]  │ │
│  │    5 人 · 15,000 USDC · 每月 1 号                         │ │
│  │    下次执行: 2025-02-01 09:00 UTC                         │ │
│  │    执行模式: 自动                      [编辑] [暂停] [删除]│ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ 📅 KOL 周结                                      [Active]  │ │
│  │    12 人 · 3,000 USDC · 每周五                            │ │
│  │    下次执行: 2025-01-31 09:00 UTC                         │ │
│  │    执行模式: 通知确认                  [编辑] [暂停] [删除]│ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ 📅 顾问费                                        [Paused]  │ │
│  │    2 人 · 5,000 USDC · 每月 15 号                         │ │
│  │    暂停原因: 手动暂停                   [编辑] [恢复] [删除]│ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  执行历史                                            [查看全部] │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 2025-01-15  月度工资  15,000 USDC  5/5 成功    [查看详情] │ │
│  │ 2025-01-10  KOL 周结   3,000 USDC  12/12 成功  [查看详情] │ │
│  │ 2025-01-01  月度工资  15,000 USDC  5/5 成功    [查看详情] │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 创建发薪计划

```
┌─────────────────────────────────────────────────────────────────┐
│  创建发薪计划                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  计划名称                                                       │
│  [___月度员工工资_______________]                               │
│                                                                 │
│  ────────────────────────────────────────────────────────────  │
│                                                                 │
│  收款人                                      [从模板加载] [导入] │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 0x123...  Alice   3,000 USDC                           ✕  │ │
│  │ 0x456...  Bob     3,500 USDC                           ✕  │ │
│  │ 0x789...  Charlie 4,000 USDC                           ✕  │ │
│  │                                              [+ 添加收款人] │ │
│  └───────────────────────────────────────────────────────────┘ │
│  总计: 10,500 USDC                                              │
│                                                                 │
│  ────────────────────────────────────────────────────────────  │
│                                                                 │
│  发薪周期                                                       │
│  ○ 每周  ○ 双周  ● 每月  ○ 自定义                               │
│                                                                 │
│  执行日期: [1] 号   执行时间: [09:00] UTC                       │
│                                                                 │
│  ────────────────────────────────────────────────────────────  │
│                                                                 │
│  执行模式                                                       │
│  ● 自动执行    到期直接执行，无需确认                           │
│  ○ 通知确认    提前 24 小时通知，确认后执行                     │
│  ○ 审批执行    需要指定审批人批准                               │
│                                                                 │
│  ────────────────────────────────────────────────────────────  │
│                                                                 │
│  高级设置 ▼                                                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ □ 设置单次限额  [_____] USDC                              │ │
│  │ □ 执行失败时通知  [email@example.com]                     │ │
│  │ □ 发送 Webhook  [https://...]                             │ │
│  │ □ 计划结束日期  [____-__-__]                              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│                                  [取消]  [保存草稿]  [创建计划]  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 边界情况

### 5.1 异常处理

| 情况 | 处理方式 |
|------|---------|
| 执行时余额不足 | 标记失败，通知用户，下次不自动重试 |
| 部分收款人失败 | 继续执行其他人，记录失败项 |
| 调度器宕机 | 恢复后补充执行（在窗口内） |
| 用户取消已触发的执行 | 允许在执行前取消 |
| Gas 价格过高 | 可配置 Gas 上限，超过则延迟 |

### 5.2 限制条件

| 项目 | 限制 | 原因 |
|------|------|------|
| 最大计划数 | 20 个/用户 | 资源控制 |
| 最大收款人数 | 100 人/计划 | 执行效率 |
| 最小执行间隔 | 1 天 | 避免滥用 |
| 提前通知时间 | 固定 24 小时 | 简化逻辑 |

---

## 6. 与现有功能集成

### 6.1 与分账功能集成

- 发薪计划可使用分账模板
- 支持百分比分配模式
- 共享收款人管理

### 6.2 与订阅功能关系

- 定时发薪是订阅功能的"付款方"视角
- 现有订阅服务代码可复用
- 需要添加自动执行调度器

### 6.3 与多签功能集成（后续）

- 大额支付可要求多签审批
- 集成 Safe 提案流程

---

## 7. 技术考虑

### 7.1 调度方案选择

| 方案 | 优点 | 缺点 | 推荐 |
|------|------|------|------|
| Vercel Cron | 免费，简单 | 最小间隔 1 天 | MVP 阶段 |
| 外部调度器 (Upstash) | 灵活，可靠 | 额外成本 | 生产阶段 |
| 自建调度服务 | 完全控制 | 维护成本高 | 后期 |

### 7.2 执行安全

- 需要用户预授权（EIP-3009 或 Approve）
- 或使用签名队列（用户提前签好交易）
- 不存储私钥

---

## 8. 发布计划

### 8.1 MVP 范围

- [x] 基础发薪计划 CRUD
- [x] 自动执行模式
- [x] 执行记录查看
- [x] 站内通知
- [ ] 通知确认模式（可放 v1.1）
- [ ] 审批模式（可放 v1.2）

### 8.2 后续迭代

- v1.1: 通知确认模式、Email 通知
- v1.2: 审批流程、多签集成
- v1.3: 高级调度（自定义 Cron）

---

## 9. 风险与依赖

### 9.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| Vercel Cron 不可靠 | 中 | 增加重试，监控告警 |
| 用户取消授权 | 中 | 执行前检查授权 |
| Gas 波动 | 低 | 设置 Gas 上限 |

### 9.2 依赖项

- 百分比分账功能（建议先完成）
- Vercel Cron 或外部调度服务
- 通知服务（Resend）

---

**审核人**: _待定_
**批准日期**: _待定_
