# å¤šç½‘ç»œæ”¯æŒ - æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“è¿æ¥é—®é¢˜](#æ•°æ®åº“è¿æ¥é—®é¢˜)
2. [è¿ç§»å¤±è´¥](#è¿ç§»å¤±è´¥)
3. [API é”™è¯¯](#api-é”™è¯¯)
4. [åœ°å€éªŒè¯é—®é¢˜](#åœ°å€éªŒè¯é—®é¢˜)
5. [UI ç»„ä»¶é—®é¢˜](#ui-ç»„ä»¶é—®é¢˜)
6. [æ€§èƒ½é—®é¢˜](#æ€§èƒ½é—®é¢˜)
7. [ç½‘ç»œæ£€æµ‹é—®é¢˜](#ç½‘ç»œæ£€æµ‹é—®é¢˜)

---

## æ•°æ®åº“è¿æ¥é—®é¢˜

### é—®é¢˜ 1: æ— æ³•è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡å™¨

**ç—‡çŠ¶ï¼š**
```
Error: P1001
Can't reach database server at localhost:51214
```

**å¯èƒ½åŸå› ï¼š**
1. PostgreSQL æœåŠ¡æœªå¯åŠ¨
2. ç«¯å£é…ç½®é”™è¯¯
3. é˜²ç«å¢™é˜»æ­¢è¿æ¥

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ PostgreSQL æ˜¯å¦è¿è¡Œ
# Windows
tasklist | findstr postgres
sc query postgresql-x64-15

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
netstat -an | findstr :51214

# 3. å°è¯•æ‰‹åŠ¨è¿æ¥
psql -h localhost -p 51214 -U postgres

# 4. å¦‚æœä½¿ç”¨ Docker
docker ps | findstr postgres
docker logs <container-id>

# 5. æ£€æŸ¥ .env é…ç½®
type .env | findstr DATABASE_URL
```

**ä¿®å¤æ–¹æ³•ï¼š**

```bash
# å¯åŠ¨ PostgreSQL æœåŠ¡
# Windows
net start postgresql-x64-15

# Docker
docker start <postgres-container>

# éªŒè¯è¿æ¥
psql -h localhost -p 51214 -U postgres -c "SELECT version();"
```

### é—®é¢˜ 2: è®¤è¯å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
FATAL: password authentication failed for user "postgres"
```

**è§£å†³æ–¹æ³•ï¼š**

```bash
# 1. æ£€æŸ¥ DATABASE_URL ä¸­çš„å¯†ç 
# .env æ–‡ä»¶ä¸­ï¼š
DATABASE_URL="postgresql://postgres:YOUR_PASSWORD@localhost:51214/..."

# 2. é‡ç½® PostgreSQL å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
psql -U postgres
ALTER USER postgres PASSWORD 'new_password';

# 3. æ›´æ–° .env æ–‡ä»¶ä¸­çš„å¯†ç 
```

---

## è¿ç§»å¤±è´¥

### é—®é¢˜ 3: Schema æ¨é€å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
Error: P1012
Schema validation error
```

**å¯èƒ½åŸå› ï¼š**
- Schema è¯­æ³•é”™è¯¯
- æ•°æ®åº“æƒé™ä¸è¶³
- ç°æœ‰æ•°æ®ä¸æ–° schema å†²çª

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. éªŒè¯ Prisma schema
pnpm prisma validate

# 2. æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pnpm prisma db push --help

# 3. å¼ºåˆ¶é‡ç½®ï¼ˆâš ï¸ ä¼šåˆ é™¤æ•°æ®ï¼‰
pnpm prisma db push --force-reset --accept-data-loss

# 4. æ£€æŸ¥æ•°æ®åº“æƒé™
psql -U postgres -c "SHOW is_superuser;"
```

### é—®é¢˜ 4: å”¯ä¸€çº¦æŸå†²çª

**ç—‡çŠ¶ï¼š**
```
Error: Unique constraint failed on the fields: (`vendor_id`,`network`)
```

**åŸå› ï¼š** åŒä¸€ä¸ªä¾›åº”å•†åœ¨åŒä¸€ç½‘ç»œä¸Šå·²æœ‰åœ°å€

**è§£å†³æ–¹æ³•ï¼š**

```sql
-- æŸ¥æ‰¾é‡å¤è®°å½•
SELECT vendor_id, network, COUNT(*)
FROM vendor_addresses
GROUP BY vendor_id, network
HAVING COUNT(*) > 1;

-- åˆ é™¤é‡å¤è®°å½•ï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰
DELETE FROM vendor_addresses a
USING vendor_addresses b
WHERE a.vendor_id = b.vendor_id
  AND a.network = b.network
  AND a.created_at < b.created_at;
```

### é—®é¢˜ 5: SQL è¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥

**ç—‡çŠ¶ï¼š**
```
ERROR: function ensure_one_primary_address_per_network() does not exist
```

**åŸå› ï¼š** ä½¿ç”¨ `prisma db push` ä¸ä¼šåˆ›å»ºå‡½æ•°/è§¦å‘å™¨

**è§£å†³æ–¹æ³•ï¼š**

```bash
# æ‰‹åŠ¨è¿è¡Œ SQL è¿ç§»
psql -h localhost -p 51214 -U postgres -d template1 -f scripts\009_multi_network_support.sql

# æˆ–é€ä¸ªæ‰§è¡Œï¼ˆå¦‚æœä¸Šé¢å¤±è´¥ï¼‰
psql -h localhost -p 51214 -U postgres -d template1

# ç„¶ååœ¨ psql ä¸­ï¼š
\i scripts/009_multi_network_support.sql
```

---

## API é”™è¯¯

### é—®é¢˜ 6: 401 Unauthorized

**ç—‡çŠ¶ï¼š**
```json
{ "error": "Unauthorized" }
```

**åŸå› ï¼š** ç¼ºå°‘è®¤è¯å¤´

**è§£å†³æ–¹æ³•ï¼š**

```bash
# ç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½åŒ…å« x-user-address
curl http://localhost:3000/api/vendors/multi-network \
  -H "x-user-address: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb2"

# æ£€æŸ¥ API è·¯ç”±ä»£ç 
# æ‰€æœ‰è·¯ç”±éƒ½åº”è¯¥æœ‰ï¼š
const authAddress = await getAuthenticatedAddress(request)
if (!authAddress) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
}
```

### é—®é¢˜ 7: 403 Forbidden

**ç—‡çŠ¶ï¼š**
```json
{ "error": "Forbidden: Access denied to other wallets" }
```

**åŸå› ï¼š** å°è¯•è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ•°æ®

**è§£å†³æ–¹æ³•ï¼š**

1. ç¡®ä¿è¯·æ±‚è‡ªå·±çš„æ•°æ®
2. æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

```sql
-- æ£€æŸ¥ RLS æ˜¯å¦å¯ç”¨
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'vendor_addresses';

-- æŸ¥çœ‹ RLS ç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'vendor_addresses';
```

### é—®é¢˜ 8: 500 Internal Server Error

**ç—‡çŠ¶ï¼š**
```json
{ "error": "Internal Server Error" }
```

**è°ƒè¯•æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
# ç»ˆç«¯ä¸­ä¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯

# 2. æ£€æŸ¥ Prisma client æ˜¯å¦æœ€æ–°
pnpm prisma generate

# 3. é‡å¯å¼€å‘æœåŠ¡å™¨
# Ctrl+C åœæ­¢
pnpm dev

# 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥
pnpm prisma studio
```

---

## åœ°å€éªŒè¯é—®é¢˜

### é—®é¢˜ 9: Invalid address é”™è¯¯

**ç—‡çŠ¶ï¼š**
```json
{ "error": "Invalid address: Address must be 42 characters long" }
```

**å¸¸è§åŸå› å’Œè§£å†³æ–¹æ³•ï¼š**

```typescript
// âŒ é”™è¯¯ï¼šåœ°å€é•¿åº¦ä¸å¯¹
"0x123"  // å¤ªçŸ­

// âœ… æ­£ç¡®ï¼š42 å­—ç¬¦ï¼ˆåŒ…æ‹¬ 0xï¼‰
"0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb2"

// âŒ é”™è¯¯ï¼šTRON åœ°å€æ ¼å¼é”™è¯¯
"T123"  // å¤ªçŸ­

// âœ… æ­£ç¡®ï¼š34 å­—ç¬¦ï¼ŒBase58
"TQn9Y2khEsLJW1ChVWFMSMeRDow5KcbLSE"

// âŒ é”™è¯¯ï¼šæ··æ·†ç½‘ç»œ
// ä¸èƒ½æŠŠ EVM åœ°å€å½“ä½œ TRON åœ°å€
{
  "network": "tron",
  "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb2"  // âŒ
}

// âœ… æ­£ç¡®
{
  "network": "tron",
  "address": "TQn9Y2khEsLJW1ChVWFMSMeRDow5KcbLSE"  // âœ…
}
```

### é—®é¢˜ 10: ç½‘ç»œè‡ªåŠ¨æ£€æµ‹ä¸å‡†ç¡®

**ç—‡çŠ¶ï¼š** æ‰€æœ‰ EVM åœ°å€éƒ½è¢«è¯†åˆ«ä¸º "ethereum"

**åŸå› ï¼š** è¿™æ˜¯é¢„æœŸè¡Œä¸º - æ— æ³•ä»åœ°å€æœ¬èº«åŒºåˆ† EVM é“¾

**è§£å†³æ–¹æ³•ï¼š**

```typescript
// ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æŒ‡å®šå…·ä½“çš„ EVM ç½‘ç»œ
const address = {
  network: "base",  // æ‰‹åŠ¨æŒ‡å®š
  address: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb2",
  isPrimary: true
}

// æˆ–åœ¨ UI ä¸­æä¾›ç½‘ç»œé€‰æ‹©å™¨
<NetworkSelector
  value={network}
  onChange={setNetwork}
  filterByType="EVM"  // åªæ˜¾ç¤º EVM ç½‘ç»œ
/>
```

---

## UI ç»„ä»¶é—®é¢˜

### é—®é¢˜ 11: VendorAddressManager ç»„ä»¶ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› ï¼š**
1. ç»„ä»¶æœªæ­£ç¡®å¯¼å…¥
2. Props ç±»å‹ä¸åŒ¹é…
3. ç¼ºå°‘å¿…éœ€çš„ props

**è§£å†³æ–¹æ³•ï¼š**

```tsx
// æ£€æŸ¥å¯¼å…¥è·¯å¾„
import { VendorAddressManager } from "@/components/vendors/vendor-address-manager"

// ç¡®ä¿ä¼ é€’æ‰€æœ‰å¿…éœ€çš„ props
<VendorAddressManager
  vendorId={vendor.id}              // âœ… å¿…éœ€
  addresses={vendor.addresses || []} // âœ… å¿…éœ€ï¼Œç¡®ä¿æ˜¯æ•°ç»„
  onUpdate={() => refetch()}         // âœ… å¿…éœ€
  userAddress={userAddress}          // âœ… å¿…éœ€
/>

// æ£€æŸ¥ç±»å‹å®šä¹‰
interface VendorAddress {
  id: string
  network: string
  address: string
  label?: string
  isPrimary: boolean
  verifiedAt?: string
  createdAt: string
}
```

### é—®é¢˜ 12: ç½‘ç»œå¾½ç« é¢œè‰²ä¸æ­£ç¡®

**åŸå› ï¼š** Tailwind CSS ç±»æœªåŒ…å«åœ¨æ„å»ºä¸­

**è§£å†³æ–¹æ³•ï¼š**

```typescript
// åœ¨ NetworkBadge ç»„ä»¶ä¸­ä½¿ç”¨å®Œæ•´çš„ç±»å
// âŒ é”™è¯¯ï¼šåŠ¨æ€ç±»å
const color = `bg-${colorName}-500`

// âœ… æ­£ç¡®ï¼šå®Œæ•´ç±»å
const getNetworkColor = (network: string) => {
  if (network === "tron") return "bg-red-500 hover:bg-red-600"
  if (network === "ethereum") return "bg-blue-500 hover:bg-blue-600"
  // ...
}
```

### é—®é¢˜ 13: Dialog ä¸å…³é—­

**ç—‡çŠ¶ï¼š** ç‚¹å‡»ä¿å­˜åå¯¹è¯æ¡†ä»ç„¶æ‰“å¼€

**è§£å†³æ–¹æ³•ï¼š**

```typescript
const handleSave = async () => {
  try {
    await saveAddress()
    setIsDialogOpen(false)  // âœ… ç¡®ä¿å…³é—­å¯¹è¯æ¡†
    onUpdate()               // âœ… è§¦å‘åˆ·æ–°
  } catch (error) {
    // é”™è¯¯æ—¶ä¸å…³é—­å¯¹è¯æ¡†
    console.error(error)
  }
}
```

---

## æ€§èƒ½é—®é¢˜

### é—®é¢˜ 14: æŸ¥è¯¢é€Ÿåº¦æ…¢

**ç—‡çŠ¶ï¼š** API å“åº”æ—¶é—´ > 2 ç§’

**è¯Šæ–­ï¼š**

```typescript
// å¯ç”¨ Prisma æŸ¥è¯¢æ—¥å¿—
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  log      = ["query", "info", "warn", "error"]
}
```

**ä¼˜åŒ–æ–¹æ³•ï¼š**

```sql
-- 1. æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
SELECT * FROM pg_indexes WHERE tablename = 'payments';

-- 2. åˆ›å»ºç¼ºå¤±çš„ç´¢å¼•
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_payments_network_type
ON payments(network_type);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_payments_created_at
ON payments(created_at DESC);

-- 3. åˆ†ææŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM payments
WHERE network_type = 'TRON'
ORDER BY created_at DESC
LIMIT 50;

-- 4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE payments;
ANALYZE vendor_addresses;
```

### é—®é¢˜ 15: å†…å­˜ä½¿ç”¨è¿‡é«˜

**ç—‡çŠ¶ï¼š** Node.js è¿›ç¨‹å ç”¨å¤§é‡å†…å­˜

**è§£å†³æ–¹æ³•ï¼š**

```typescript
// 1. ä½¿ç”¨åˆ†é¡µï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤ªå¤šæ•°æ®
const payments = await prisma.payment.findMany({
  take: 100,  // âœ… é™åˆ¶è¿”å›æ•°é‡
  skip: offset,
  where: { ... }
})

// 2. åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
const payments = await prisma.payment.findMany({
  select: {
    id: true,
    amount: true,
    network_type: true,
    // ä¸è¦ç”¨ select: *
  }
})

// 3. ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆå¤§æ•°æ®é›†ï¼‰
const payments = await prisma.payment.findMany({
  take: 100,
  cursor: { id: lastId },
  orderBy: { created_at: 'desc' }
})
```

---

## ç½‘ç»œæ£€æµ‹é—®é¢˜

### é—®é¢˜ 16: TRON åœ°å€è¢«è¯†åˆ«ä¸ºæ— æ•ˆ

**ç—‡çŠ¶ï¼š**
```json
{ "error": "Invalid address: Invalid Base58 encoding" }
```

**å¯èƒ½åŸå› ï¼š**
1. åœ°å€åŒ…å«æ— æ•ˆçš„ Base58 å­—ç¬¦
2. åœ°å€é•¿åº¦ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•ï¼š**

```typescript
// éªŒè¯ TRON åœ°å€
import { validateAddress } from "@/lib/address-utils"

const validation = validateAddress("TQn9Y2khEsLJW1ChVWFMSMeRDow5KcbLSE")

if (!validation.isValid) {
  console.error(validation.error)
  // "Invalid Base58 encoding" æˆ–å…¶ä»–é”™è¯¯
}

// æ£€æŸ¥åœ°å€æ ¼å¼
// âœ… æ­£ç¡®ï¼šT å¼€å¤´ï¼Œ34 å­—ç¬¦ï¼ŒåªåŒ…å« Base58 å­—ç¬¦
"TQn9Y2khEsLJW1ChVWFMSMeRDow5KcbLSE"

// âŒ é”™è¯¯ç¤ºä¾‹ï¼š
"TQn9Y2khEs0LJW1ChVWFMSMeRDow5KcbLSE"  // åŒ…å« '0'ï¼ˆä¸æ˜¯ Base58ï¼‰
"TQn9Y2khEsLJW1ChVWFMSMeRDow"        // å¤ªçŸ­
```

### é—®é¢˜ 17: æ‰¹é‡æ”¯ä»˜æ£€æµ‹åˆ°é”™è¯¯çš„ç½‘ç»œ

**ç—‡çŠ¶ï¼š** æ‰¹é‡æ”¯ä»˜è¢«åˆ†é…åˆ°é”™è¯¯çš„ç½‘ç»œ

**åŸå› ï¼š** åªæ£€æµ‹äº†ç¬¬ä¸€ä¸ªæ”¶æ¬¾äººåœ°å€

**è§£å†³æ–¹æ³•ï¼š**

```typescript
// ç¡®ä¿æ‰€æœ‰æ”¶æ¬¾äººåœ¨åŒä¸€ç½‘ç»œä¸Š
const recipients = [
  { address: "0x...", amount: "10" },  // EVM
  { address: "0x...", amount: "20" },  // EVM
  // âŒ ä¸è¦æ··åˆç½‘ç»œç±»å‹
  // { address: "TQn9...", amount: "30" }  // TRON
]

// éªŒè¯æ‰€æœ‰åœ°å€
recipients.forEach(r => {
  const validation = validateAddress(r.address)
  if (validation.type !== expectedType) {
    throw new Error("æ‰€æœ‰æ”¶æ¬¾äººå¿…é¡»åœ¨åŒä¸€ç½‘ç»œä¸Š")
  }
})
```

---

## æ—¥å¿—å’Œè°ƒè¯•

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```typescript
// lib/prisma.ts
const prisma = new PrismaClient({
  log: ['query', 'error', 'warn'],
})

// æˆ–åœ¨å¼€å‘ç¯å¢ƒ
const prisma = new PrismaClient({
  log: process.env.NODE_ENV === 'development'
    ? ['query', 'error', 'warn', 'info']
    : ['error'],
})
```

### ä½¿ç”¨æµè§ˆå™¨å¼€å‘å·¥å…·

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è°ƒè¯•
// 1. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
// DevTools â†’ Network â†’ ç­›é€‰ Fetch/XHR

// 2. æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…
// ç‚¹å‡»è¯·æ±‚ â†’ Headers â†’ æ£€æŸ¥ x-user-address
// Payload â†’ æ£€æŸ¥è¯·æ±‚ä½“
// Response â†’ æ£€æŸ¥å“åº”

// 3. æ£€æŸ¥ React çŠ¶æ€
// React DevTools â†’ Components â†’ é€‰æ‹©ç»„ä»¶ â†’ æŸ¥çœ‹ props/state
```

---

## è·å–å¸®åŠ©

å¦‚æœä¸Šè¿°æ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. **æ£€æŸ¥æ–‡æ¡£**
   - [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md)
   - [TESTING_GUIDE.md](./TESTING_GUIDE.md)
   - [MULTI_NETWORK_IMPLEMENTATION.md](./MULTI_NETWORK_IMPLEMENTATION.md)

2. **æŸ¥çœ‹æ—¥å¿—**
   - å¼€å‘æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡º
   - æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - PostgreSQL æ—¥å¿—

3. **éªŒè¯ç¯å¢ƒ**
   ```bash
   node --version  # éœ€è¦ 18+
   pnpm --version
   psql --version
   ```

4. **é‡æ–°å¼€å§‹**
   ```bash
   # æ¸…ç†å¹¶é‡æ–°å®‰è£…
   rm -rf node_modules .next
   pnpm install
   pnpm prisma generate
   pnpm dev
   ```

---

**æœ€åæ›´æ–°ï¼š** 2026-02-07
